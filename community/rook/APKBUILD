# Maintainer: Anthony Davies <anthony.t.davies@gmail.com>
pkgname=rook
pkgver=1.2.1
pkgrel=0
pkgdesc="Rook is an open source cloud-native storage orchestrator for Kubernetes"
url="https://github.com/root/root"
arch="x86_64 aarch64 armv7"
license="Apache-2.0"
options="!check !fhs"
makedepends="go bash" 
source="$pkgname-$pkgver.tar.gz::https://github.com/rook/rook/archive/v$pkgver.tar.gz"
builddir="$srcdir/src/github.com/rook/$pkgname"
subpackages="$pkgname-ceph"
#export GOPATH="$startdir"
export GOPATH="$srcdir"


prepare() {
	mkdir -p ${builddir%/*}
	mv "$srcdir"/$pkgname-$pkgver "$builddir"/ || return 1
	cd "$builddir"
	default_prepare
}


build() {
	#mkdir -p "$srcdir/github.com/rook"
	#cp -r $builddir "$srcdir/github.com/rook/rook/"
	#builddir="$srcdir/github.com/rook/rook"
	make SHA256CMD=/usr/bin/sha256sum GO_STATIC_PACKAGES=github.com/rook/rook/cmd/rook go.init
	#make SHA256CMD=/usr/bin/sha256sum GO_STATIC_PACKAGES=github.com/rook/rook/cmd/rook go.build VERBOSE=1
	go build -v -o _output/bin/rook github.com/rook/rook/cmd/rook
	cd images/ceph
	make SHA256CMD=/usr/bin/sha256sum generate-csv-ceph-templates
}

package() {
	cd $builddir
	mkdir -p $pkgdir/usr/bin
	cp _output/bin/rook $pkgdir/usr/bin/

}

ceph() {
	depends="rook"
	cd $builddir
	mkdir -p $subpkgdir/etc/ $subpkgdir/usr/local/bin
	cp -r cluster/examples/kubernetes/ceph/csi/template $subpkgdir/etc/ceph-csi
	cp -r cluster/examples/kubernetes/ceph/monitoring $subpkgdir/etc/ceph-monitoring
	cp -r cluster/olm/ceph/templates $subpkgdir/etc/ceph-csv-templates
	cp images/ceph/toolbox.sh $subpkgdir/usr/local/bin/
}
sha512sums="e9ada7b73e7142441608cc313e9191cb215e0446b98f5f1424b6b4c9260308146497916bed4dc217944c86c4262f7b976c77f739abbd470d79b0083154222a91  rook-1.2.1.tar.gz"
