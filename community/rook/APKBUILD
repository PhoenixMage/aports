# Maintainer: Anthony Davies <anthony.t.davies@gmail.com>
pkgname=rook
pkgver=1.2.2
pkgrel=0
pkgdesc="Rook is an open source cloud-native storage orchestrator for Kubernetes"
url="https://github.com/root/root"
arch="x86_64 aarch64 armv7"
license="Apache-2.0"
options="!check !fhs"
makedepends="go bash" 
source="$pkgname-$pkgver.tar.gz::https://github.com/rook/rook/archive/v$pkgver.tar.gz
	multi-arm.patch"
builddir="$srcdir/src/github.com/rook/$pkgname"
subpackages="$pkgname-ceph"
export GOPATH="$srcdir"


prepare() {
	mkdir -p ${builddir%/*}
	mv "$srcdir"/$pkgname-$pkgver "$builddir"/ || return 1
	cd "$builddir"
	default_prepare
}


build() {
	sed -i -e 's/LDFLAGS ?=$/LDFLAGS =/' Makefile
	make SHA256CMD=/usr/bin/sha256sum GO_STATIC_PACKAGES=github.com/rook/rook/cmd/rook go.init
	make SHA256CMD=/usr/bin/sha256sum GO_STATIC_PACKAGES=github.com/rook/rook/cmd/rook VERSION=v$pkgver go.build
	case "$CARCH" in
		x86_64)
			cd images/ceph
			make SHA256CMD=/usr/bin/sha256sum generate-csv-ceph-templates
			;;
		*)
			mkdir cluster/olm/ceph/templates
			;;
	esac
}

package() {
	cd $builddir
	mkdir -p $pkgdir/usr/bin
	find _output -name rook -exec cp {} $pkgdir/usr/bin/ \;
}

ceph() {
	depends="rook"
	cd $builddir
	mkdir -p $subpkgdir/etc/ $subpkgdir/usr/local/bin
	cp -r cluster/examples/kubernetes/ceph/csi/template $subpkgdir/etc/ceph-csi
	cp -r cluster/examples/kubernetes/ceph/monitoring $subpkgdir/etc/ceph-monitoring
	cp -r cluster/olm/ceph/templates $subpkgdir/etc/ceph-csv-templates
	cp images/ceph/toolbox.sh $subpkgdir/usr/local/bin/
}
sha512sums="bd3ae8bc0e533e5db2b24becf0a7980aa75aa87809c4eb6193b890428b521df4b1475d8f5a034f41585288ef1621f93d22d30f7aeda08e76218750a8c59659f9  rook-1.2.2.tar.gz
469530bdb0f616ab19bc733065b001c20b1fe3c8be36dd6fde36bccbd231b03970becea8142a0e58bd425d84704830a75050b0e2a1d633bbe457c02234edda62  multi-arm.patch"
